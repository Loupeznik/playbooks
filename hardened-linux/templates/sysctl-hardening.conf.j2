# Kernel Hardening Parameters
# Managed by Ansible - Do not edit manually

# IP Forwarding
net.ipv4.ip_forward = 0
{% if not disable_ipv6 %}
net.ipv6.conf.all.forwarding = 0
{% endif %}

# SYN Flood Protection
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 2048
net.ipv4.tcp_synack_retries = 2
net.ipv4.tcp_syn_retries = 5

# IP Spoofing Protection
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# Ignore ICMP Redirects
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0
{% if not disable_ipv6 %}
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0
{% endif %}

# Do not send ICMP redirects
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0

# Disable Source Packet Routing
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
{% if not disable_ipv6 %}
net.ipv6.conf.all.accept_source_route = 0
net.ipv6.conf.default.accept_source_route = 0
{% endif %}

# Log Martian Packets
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1

# Ignore ICMP Ping Requests (optional)
# net.ipv4.icmp_echo_ignore_all = 1
# net.ipv6.icmp.echo_ignore_all = 1

# Ignore Bogus ICMP Errors
net.ipv4.icmp_ignore_bogus_error_responses = 1

# Protect Against TCP Time-Wait Assassination
net.ipv4.tcp_rfc1337 = 1

# Disable TCP Timestamps (may break some applications)
net.ipv4.tcp_timestamps = 0

# ARP Protection
net.ipv4.conf.all.arp_ignore = 1
net.ipv4.conf.all.arp_announce = 2

{% if disable_ipv6 %}
# Disable IPv6
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 1
{% endif %}

# Enable Address Space Layout Randomization (ASLR)
kernel.randomize_va_space = 2

# Kernel Pointer Protection
kernel.kptr_restrict = 2

# Restrict Dmesg Access
kernel.dmesg_restrict = 1

# Restrict Kernel Logs Access
kernel.printk = 3 3 3 3

# Address Space Layout Randomization
kernel.randomize_va_space = 2

# Core Dumps
{% if not enable_core_dumps %}
fs.suid_dumpable = 0
kernel.core_uses_pid = 1
{% endif %}

# Increase inotify limits (for applications that watch many files)
fs.inotify.max_user_watches = 524288
fs.inotify.max_user_instances = 512

# Increase PID max (useful for build servers with many processes)
kernel.pid_max = 4194304

# Increase file descriptor limits
fs.file-max = 2097152

# Shared Memory Protection
vm.mmap_min_addr = 65536

# Swap usage
vm.swappiness = 10

# Connection tracking
net.netfilter.nf_conntrack_max = 262144

# TCP hardening
net.ipv4.tcp_fin_timeout = 15
net.ipv4.tcp_keepalive_time = 300
net.ipv4.tcp_keepalive_probes = 5
net.ipv4.tcp_keepalive_intvl = 15

# Increase ephemeral port range
net.ipv4.ip_local_port_range = 1024 65535

# TCP Fast Open
net.ipv4.tcp_fastopen = 3

# BBR congestion control (optional, comment out if not supported)
# net.core.default_qdisc = fq
# net.ipv4.tcp_congestion_control = bbr
